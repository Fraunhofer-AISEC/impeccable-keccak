# Description
This repository contains the code for the ["Impeccable Keccak"](https://tches.iacr.org/index.php/TCHES/article/view/11424)[1] paper and has the following structure:
* `Keccak` folder contains all relevant VHDL files and python scripts to generate them.
* `simulation` folder contains python scripts to simulate the proposed countermeasure against 
faults with the total Hamming weight less than four.
* `test_generation` folder contains python scripts for the test vectors generation to ensure the correctness of the design. <br />


# Build Project

1. Go to the `Keccak` folder.
2. Execute `gen_rho_matrices.py`. This script generates rotation matrices, which are involved into `theta` and `rho` permutations. 
```
python3 gen_rho_matrices.py
```
3. Create a new vivado project and add all `.vhd` files from `Keccak` as source files. 
4. If no errors occured, `tb_keccak_1600` should be defined as the main module.
###### Note:
`rho_l4.vhd` contains two implementations of the encoded `rho` permuation. By default, Keccak is computed using matrices generated by the `gen_rho_matrices.py` script (`theta_l4` uses one of them (`rho_1`)). However, `rho_l4` can be also executed using `rho_l4_(i)mod4` modules. To do so, uncomment corresponding lines in the `rho_l4.vhd` file and comment unused lines. If certain rotation in `rho_l4.vhd` does not contain commented instantiation of `rho_l4_(i)mod4` module, its implementation does not differ from the default one. Do not comment these lines.
 
### Generate test vectors

1. Copy the `test_generator` folder to the top `(project_name)` folder generated by vivado.
2. Go to the `test_generator` folder 
```
cd (project_name)/test_generator
```
and create `test_vectors` repository. 
```
mkdir test_vectors
```
3. Execute `gen_test_vectors.py` script to generate test vectors. 
```
python3 gen_test_vectors.py
```
Test vectors will be stored in the `(project_name)/test_generator/test_vectors` folder. The default number of test vectors is 2, but it can be customized using `-n` parameter, e.g. 
```
python3 gen_test_vectors.py -n 10
```

### Simulate

1. Start Vivado simulation.
2. Compare `test_ref_out.txt` and `simulation_out.txt` files in the `(project_name)/test_generator/test_vectors` folder.

# Simulation 
The project contains simulation of `theta` and `rho` permutations. To simulate faults within them, go to the `simulation` folder and run `simulation.py`.
```
python3 simulation.py
```
The sctipt generates all relevant fault injections patterns.

# References
[1]. Gavrilan, I., Oberhansl, F., Wagner, A., Strieder, E., & Zankl, A. (2024). Impeccable Keccak: Towards Fault Resilient SPHINCS+ Implementations. IACR Transactions on Cryptographic Hardware and Embedded Systems, 2024(2), 154-189.</a>
